import { createServer } from 'http';\nimport { Server } from 'socket.io';\nimport { BedrockRuntimeClient } from '@aws-sdk/client-bedrock-runtime';\nimport { NodeHttp2Handler } from '@smithy/node-http-handler';\n\n// Create HTTP server\nconst httpServer = createServer();\nconst io = new Server(httpServer, {\n  cors: {\n    origin: process.env.NODE_ENV === 'production' ? false : ['http://localhost:3000'],\n    methods: ['GET', 'POST']\n  }\n});\n\n// Nova Sonic client setup\nconst bedrockClient = new BedrockRuntimeClient({\n  region: process.env.AWS_REGION || 'us-east-1',\n  credentials: {\n    accessKeyId: process.env.AWS_ACCESS_KEY_ID!,\n    secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY!\n  },\n  requestHandler: new NodeHttp2Handler({\n    requestTimeout: 300000,\n    sessionTimeout: 300000\n  })\n});\n\n// Session management\ninterface InterviewSession {\n  sessionId: string;\n  interviewData: any;\n  isActive: boolean;\n  messages: Array<{role: string, content: string}>;\n}\n\nconst activeSessions = new Map<string, InterviewSession>();\n\n// Socket.IO connection handler\nio.on('connection', (socket) => {\n  console.log('Client connected:', socket.id);\n  \n  let currentSession: InterviewSession | null = null;\n\n  socket.on('initializeConnection', (callback) => {\n    try {\n      currentSession = {\n        sessionId: socket.id,\n        interviewData: null,\n        isActive: true,\n        messages: []\n      };\n      \n      activeSessions.set(socket.id, currentSession);\n      console.log('Session initialized:', socket.id);\n      \n      if (callback) callback({ success: true });\n    } catch (error) {\n      console.error('Error initializing session:', error);\n      if (callback) callback({ success: false, error: error });\n    }\n  });\n\n  socket.on('promptStart', () => {\n    console.log('Prompt start for session:', socket.id);\n    // Session setup complete\n  });\n\n  socket.on('systemPrompt', (promptText: string) => {\n    console.log('System prompt received:', promptText.substring(0, 100) + '...');\n    \n    if (currentSession) {\n      currentSession.messages.push({\n        role: 'system',\n        content: promptText\n      });\n      \n      // AI speaks first - send initial greeting\n      setTimeout(() => {\n        const greeting = \"Hello! I'm excited to interview you for this position today. Let's begin - could you tell me a bit about yourself and what drew you to this role?\";\n        \n        currentSession?.messages.push({\n          role: 'assistant', \n          content: greeting\n        });\n        \n        socket.emit('textOutput', { content: greeting });\n      }, 1000);\n    }\n  });\n\n  socket.on('audioStart', () => {\n    console.log('Audio start for session:', socket.id);\n    socket.emit('audioReady');\n  });\n\n  socket.on('audioInput', async (audioData: string) => {\n    try {\n      if (!currentSession) return;\n      \n      // Simulate speech-to-text (in real implementation, use AWS Transcribe)\n      const userText = \"[User spoke - audio received]\";\n      \n      currentSession.messages.push({\n        role: 'user',\n        content: userText\n      });\n      \n      // Generate AI response using Bedrock\n      const aiResponse = await generateInterviewResponse(currentSession);\n      \n      currentSession.messages.push({\n        role: 'assistant',\n        content: aiResponse\n      });\n      \n      // Send response back to client\n      socket.emit('textOutput', { content: aiResponse });\n      \n    } catch (error) {\n      console.error('Error processing audio:', error);\n      socket.emit('error', { message: 'Error processing audio input' });\n    }\n  });\n\n  socket.on('stopAudio', () => {\n    console.log('Stop audio for session:', socket.id);\n    if (currentSession) {\n      currentSession.isActive = false;\n    }\n    socket.emit('sessionClosed');\n  });\n\n  socket.on('disconnect', () => {\n    console.log('Client disconnected:', socket.id);\n    if (currentSession) {\n      activeSessions.delete(socket.id);\n    }\n  });\n});\n\n// Generate AI interview responses\nasync function generateInterviewResponse(session: InterviewSession): Promise<string> {\n  try {\n    const conversationContext = session.messages\n      .filter(m => m.role !== 'system')\n      .map(m => `${m.role}: ${m.content}`)\n      .join('\\n');\n    \n    const prompt = `You are conducting a professional interview. Based on this conversation:\\n\\n${conversationContext}\\n\\nProvide a thoughtful follow-up question or response. Keep it conversational and under 50 words.`;\n    \n    // Use your existing Bedrock service\n    const response = await fetch('http://localhost:3000/api/bedrock/interview', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        message: prompt,\n        interviewData: session.interviewData || {\n          role: 'Software Developer',\n          level: 'Senior',\n          techstack: ['JavaScript', 'React']\n        }\n      })\n    });\n    \n    const data = await response.json();\n    return data.success ? data.response : \"Could you tell me more about that?\";\n    \n  } catch (error) {\n    console.error('Error generating response:', error);\n    return \"That's interesting. Could you elaborate on that?\";\n  }\n}\n\n// Start server\nconst PORT = process.env.SOCKET_PORT || 3001;\nhttpServer.listen(PORT, () => {\n  console.log(`Nova Sonic server running on port ${PORT}`);\n});\n\nexport default httpServer;